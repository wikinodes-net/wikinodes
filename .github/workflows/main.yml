name: CI
on: [push, pull_request]

defaults:
  run:
    working-directory: backend-holochain

jobs:
  test-nix:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90

    strategy:
      matrix:
        os: [macos-10.15, macos-11, ubuntu-20.04]
      fail-fast: false

    steps:
      - name: Fetch source code
        uses: actions/checkout@v2

      - name: Set up nix
        uses: cachix/install-nix-action@v13
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            substituters = https://cache.nixos.org/ https://cache.holo.host/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.holo.host-1:lNXIXtJgS9Iuw4Cu6X0HINLu9sTfcjEntnrgwMQIMcE= cache.holo.host-2:ZJCkX3AUYZ8soxTLfTb60g+F3MkWD7hkH9y8CgqwhDQ=
      - name: Cache nix with Cachix
        uses: cachix/cachix-action@v10
        with:
          name: holochain
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install recent bash, and set as NIX_BUILD_SHELL # needed by macos, which has an older bash incompatible with nix
        run: echo "NIX_BUILD_SHELL=$(nix-build -A bashInteractive '<nixpkgs>')/bin/bash" >> $GITHUB_ENV

      - uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: Prepare Nix environment
        run: nix-shell --command "echo Completed"

      - run: nix-shell --run 'cd tests && npm install'

      - name: Run tests
        run: make nix-test
        timeout-minutes: 10 # sometimes failing tryorama tests hang...


  # test-raw:
  #   runs-on: ${{ matrix.os }}

  #   strategy:
  #     matrix:
  #       # os: [macos-11, ubuntu-latest]
  #       # os: [macos-10.15, ubuntu-latest]
  #       os: [ubuntu-latest]
  #       node-version: [14.x]

  #   steps:
  #     - run: uname -a
  #     - run: node -v
  #     - run: npm -v

  #     - name: Fetch source code
  #       uses: actions/checkout@v2

  #     - name: Use Node.js 14.x
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: 14.x

  #     - uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         # toolchain: nightly
  #         target: wasm32-unknown-unknown
  #     - run: rustup component list --installed
  #     - run: rustup show

  #     - run: scripts/install-hc-tools.sh
  #     - run: cd tests && npm install && npm test
